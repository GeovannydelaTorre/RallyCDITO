<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/10433/10433045.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rally Académico</title>
    <!-- Firebase App (el núcleo de Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --accent: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: inline-block;
            text-align: center;
            text-decoration: none;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--secondary);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--accent);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .card-option {
            width: 150px;
            height: 200px;
            perspective: 1000px;
            cursor: pointer;
        }
        
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .card-option.flipped .card-inner {
            transform: rotateY(180deg);
        }
        
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .card-front {
            background-color: var(--primary);
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        .card-back {
            background-color: white;
            color: var(--dark);
            transform: rotateY(180deg);
            font-size: 18px;
        }
        
        .options-container {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }
        
        .option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option:hover {
            border-color: var(--primary);
            background-color: #f8f9fa;
        }
        
        .option.selected {
            border-color: var(--secondary);
            background-color: rgba(46, 204, 113, 0.1);
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: var(--dark);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary);
            color: white;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .admin-panel {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin: 20px 0;
        }
        
        .admin-login {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }
        
        .welcome-screen h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .welcome-screen p {
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .link-display {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
        }
        
        .teacher-panel {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .team-management-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .team-management-form .form-group {
            margin-bottom: 15px;
        }
        
        .team-management-form .full-width {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .cards-container {
                flex-direction: column;
                align-items: center;
            }
            
            .card-option {
                width: 100%;
                max-width: 200px;
            }
            
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .team-management-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Rally Académico</h1>
        </header>

        <!-- Pantalla de bienvenida -->
        <div id="welcome-screen" class="card welcome-screen">
            <h2>¡Bienvenido al Rally Académico!</h2>
            <p>Para participar, escanea el código QR en una de las estaciones del rally.</p>
            <p>Después de responder una pregunta, se te pedirá que ingreses tu número de equipo y clave.</p>
            <div class="admin-access">
                <h3>Acceso Administrador</h3>
                <button id="admin-access-btn" class="btn">Acceder al Panel de Administración</button>
            </div>
        </div>

        <!-- Pantalla de selección de pregunta (aparece al escanear QR) -->
        <div id="question-selection" class="card hidden">
            <h2>Estación <span id="station-number">1</span></h2>
            <p>Selecciona una carta para revelar tu pregunta:</p>
            <div class="cards-container" id="cards-container">
                <!-- Las cartas se generarán dinámicamente -->
            </div>
            <div class="footer-note">
                <p>Después de responder, se te pedirá que ingreses tu información de equipo.</p>
            </div>
        </div>

        <!-- Pantalla de pregunta -->
        <div id="question-screen" class="card hidden">
            <h2>Pregunta - Estación <span id="question-station">1</span></h2>
            <p id="question-text"></p>
            <div class="options-container" id="options-container">
                <!-- Las opciones se generarán dinámicamente -->
            </div>
            <button id="submit-answer" class="btn btn-success">Enviar Respuesta</button>
        </div>

        <!-- Pantalla de registro de equipo -->
        <div id="team-registration" class="card hidden">
            <h2>Registro de Equipo</h2>
            <p>Por favor ingresa la información de tu equipo para registrar tu respuesta:</p>
            <div class="form-group">
                <label for="team-number">Número de Equipo</label>
                <input type="number" id="team-number" min="1" placeholder="Ingresa tu número de equipo">
            </div>
            <div class="form-group">
                <label for="team-key">Clave de Equipo</label>
                <input type="password" id="team-key" placeholder="Ingresa tu clave de equipo">
            </div>
            <button id="register-team" class="btn">Registrar Respuesta</button>
            <p id="registration-message" class="hidden" style="margin-top: 15px; padding: 10px; border-radius: 4px;"></p>
        </div>

        <!-- Pantalla de confirmación -->
        <div id="confirmation-screen" class="card hidden">
            <h2>¡Respuesta Registrada!</h2>
            <p>Tu respuesta ha sido guardada correctamente.</p>
            <p>Continúa a la siguiente estación.</p>
            <button id="next-station" class="btn">Continuar</button>
        </div>

        <!-- Pantalla de finalización -->
        <div id="finish-screen" class="card hidden">
            <h2>Finalizar Rally</h2>
            <p>Ingresa la información de tu equipo para registrar tu tiempo de finalización:</p>
            <div class="form-group">
                <label for="finish-team-number">Número de Equipo</label>
                <input type="number" id="finish-team-number" min="1" placeholder="Ingresa tu número de equipo">
            </div>
            <div class="form-group">
                <label for="finish-team-key">Clave de Equipo</label>
                <input type="password" id="finish-team-key" placeholder="Ingresa tu clave de equipo">
            </div>
            <button id="finish-team" class="btn btn-success">Registrar Tiempo Final</button>
            <p id="finish-message" class="hidden" style="margin-top: 15px; padding: 10px; border-radius: 4px;"></p>
        </div>

        <!-- Login de Administrador -->
        <div id="admin-login" class="card admin-login hidden">
            <h2>Acceso Administrador</h2>
            <div class="form-group">
                <label for="admin-password">Contraseña de Administrador</label>
                <input type="password" id="admin-password" placeholder="Ingresa la contraseña">
            </div>
            <button id="admin-login-btn" class="btn">Acceder</button>
            <button id="back-to-welcome" class="btn" style="background-color: #7f8c8d;">Volver</button>
            <p id="admin-login-message" class="hidden" style="margin-top: 15px; padding: 10px; border-radius: 4px;"></p>
        </div>

        <!-- Panel de Administración -->
        <div id="admin-panel" class="card hidden">
            <h2>Panel de Administración</h2>
            
            <div class="admin-panel">
                <h3>Control del Rally</h3>
                <div class="timer" id="admin-timer">00:00:00</div>
                <button id="start-timer" class="btn">Iniciar Cronómetro</button>
                <button id="stop-timer" class="btn">Detener Cronómetro</button>
                <button id="reset-timer" class="btn">Reiniciar Cronómetro</button>
                <button id="reset-rally" class="btn btn-danger">Reiniciar Rally</button>
                <button id="logout-admin" class="btn" style="background-color: #7f8c8d;">Cerrar Sesión</button>
            </div>
            
            <div class="admin-panel">
                <h3>Links de Estaciones</h3>
                <button id="generate-links" class="btn">Generar Links</button>
                <table id="links-table" class="hidden">
                    <thead>
                        <tr>
                            <th>Estación</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los links se generarán dinámicamente -->
                    </tbody>
                </table>
                <div id="links-concatenated" class="hidden">
                    <h4>Links concatenados:</h4>
                    <p id="links-string" class="link-display"></p>
                </div>
            </div>

            <div class="admin-panel">
                <h3>Link de Finalización</h3>
                <p id="finish-link" class="link-display"></p>
            </div>
            
            <div class="admin-panel">
                <h3>Reporte de Resultados</h3>
                <button id="view-results" class="btn">Ver Resultados</button>
                <table id="results-table" class="hidden">
                    <thead>
                        <tr>
                            <th>Equipo</th>
                            <th>Puntuación</th>
                            <th>Tiempo</th>
                            <th>Estaciones Completadas</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los resultados se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>

            <div class="admin-panel">
                <h3>Gestión de Equipos</h3>
                <button id="manage-teams" class="btn">Gestionar Equipos</button>
                <div id="teams-management" class="hidden">
                    <h4>Agregar/Editar Equipo</h4>
                    <div class="team-management-form">
                        <div class="form-group">
                            <label for="team-id">Número de Equipo</label>
                            <input type="number" id="team-id" min="1">
                        </div>
                        <div class="form-group">
                            <label for="team-key-input">Clave del Equipo</label>
                            <input type="text" id="team-key-input">
                        </div>
                        <div class="form-group">
                            <label for="team-completed">Completado</label>
                            <input type="checkbox" id="team-completed">
                        </div>
                        <div class="form-group full-width">
                            <label>Información actual del equipo:</label>
                            <div id="team-info">
                                <p>Start Time: <span id="team-start-time">No establecido</span></p>
                                <p>Finish Time: <span id="team-finish-time">No establecido</span></p>
                                <p>Respuestas: <span id="team-answers-count">0</span></p>
                            </div>
                        </div>
                    </div>
                    <button id="save-team" class="btn">Guardar Equipo</button>
                    <button id="reset-team-times" class="btn">Resetear Tiempos</button>
                    <button id="reset-team-answers" class="btn">Resetear Respuestas</button>
                    <button id="delete-team" class="btn btn-danger">Eliminar Equipo</button>
                    <h4>Lista de Equipos</h4>
                    <table id="teams-table">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Clave</th>
                                <th>Completado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los equipos se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-panel">
                <h3>Vista de Docentes</h3>
                <p>Acceso a la vista de seguimiento de equipos:</p>
                <p id="teacher-link" class="link-display"></p>
            </div>
        </div>

        <!-- Vista de Docentes -->
        <div id="teacher-panel" class="card hidden">
            <h2>Vista de Docentes</h2>
            <button id="refresh-teacher" class="btn">Actualizar Datos</button>
            <button id="back-to-admin-from-teacher" class="btn">Volver al Panel de Administración</button>
            <div class="teacher-panel">
                <table id="teacher-table">
                    <thead>
                        <tr>
                            <th>Estación</th>
                            <th>Equipo</th>
                            <th>Pregunta</th>
                            <th>Respuesta</th>
                            <th>Correcta</th>
                            <th>Castigo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Rally Académico - Sistema de Competencia</p>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD9ZkSYVakAuPWIAfgDB3EAqpgUJkrkPRo",
            authDomain: "webrallyito.firebasestorage.app",
            projectId: "webrallyito",
            storageBucket: "webrallyito.firebasestorage.app",
            messagingSenderId: "469749169879",
            appId: "1:469749169879:web:9c7f367089b5dacdebfa92"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variables globales
        let currentTeam = null;
        let currentStation = 1;
        let currentQuestion = null;
        let selectedOption = null;
        let teamAnswers = {};
        let adminAuthenticated = false;
        
        // Claves estáticas para las estaciones
        const stationKeys = [
            'aB3dEfG7', 'hI8jKlmN', 'oP9qRsT0', 'uV1wXyZ2', 
            'bC4eFgH5', 'iJ6kLmN7', 'pQ8rStU9', 'vW0xYzA1',
            'cD5fGhI8', 'jK7lMnO9'
        ];
        
        let globalTimer = null; // Cronómetro global
        let timerRunning = false;
        let timerStart = null;
        let timerValue = 0;

        

        // Referencias a elementos DOM
        const welcomeScreen = document.getElementById('welcome-screen');
        const questionSelection = document.getElementById('question-selection');
        const questionScreen = document.getElementById('question-screen');
        const teamRegistration = document.getElementById('team-registration');
        const confirmationScreen = document.getElementById('confirmation-screen');
        const finishScreen = document.getElementById('finish-screen');
        const adminLogin = document.getElementById('admin-login');
        const adminPanel = document.getElementById('admin-panel');
        const teacherPanel = document.getElementById('teacher-panel');
        const stationNumber = document.getElementById('station-number');
        const questionStation = document.getElementById('question-station');
        const cardsContainer = document.getElementById('cards-container');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const submitAnswer = document.getElementById('submit-answer');
        const teamNumberInput = document.getElementById('team-number');
        const teamKeyInput = document.getElementById('team-key');
        const registerTeam = document.getElementById('register-team');
        const registrationMessage = document.getElementById('registration-message');
        const nextStation = document.getElementById('next-station');
        const finishTeamNumber = document.getElementById('finish-team-number');
        const finishTeamKey = document.getElementById('finish-team-key');
        const finishTeamBtn = document.getElementById('finish-team');
        const finishMessage = document.getElementById('finish-message');
        const adminAccessBtn = document.getElementById('admin-access-btn');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLoginMessage = document.getElementById('admin-login-message');
        const backToWelcome = document.getElementById('back-to-welcome');
        const startTimerBtn = document.getElementById('start-timer');
        const stopTimerBtn = document.getElementById('stop-timer');
        const resetTimerBtn = document.getElementById('reset-timer');
        const resetRally = document.getElementById('reset-rally');
        const logoutAdmin = document.getElementById('logout-admin');
        const generateLinks = document.getElementById('generate-links');
        const linksTable = document.getElementById('links-table');
        const linksTableBody = linksTable.querySelector('tbody');
        const linksConcatenated = document.getElementById('links-concatenated');
        const linksString = document.getElementById('links-string');
        const finishLink = document.getElementById('finish-link');
        const teacherLink = document.getElementById('teacher-link');
        const viewResults = document.getElementById('view-results');
        const resultsTable = document.getElementById('results-table');
        const manageTeams = document.getElementById('manage-teams');
        const teamsManagement = document.getElementById('teams-management');
        const teamIdInput = document.getElementById('team-id');
        const teamKeyInputManagement = document.getElementById('team-key-input');
        const teamCompleted = document.getElementById('team-completed');
        const saveTeam = document.getElementById('save-team');
        const resetTeamTimes = document.getElementById('reset-team-times');
        const resetTeamAnswers = document.getElementById('reset-team-answers');
        const deleteTeamBtn = document.getElementById('delete-team');
        const teamsTable = document.getElementById('teams-table');
        const refreshTeacher = document.getElementById('refresh-teacher');
        const backToAdminFromTeacher = document.getElementById('back-to-admin-from-teacher');
        const teacherTable = document.getElementById('teacher-table');

        // Event Listeners
        submitAnswer.addEventListener('click', handleAnswerSubmission);
        registerTeam.addEventListener('click', handleTeamRegistration);
        nextStation.addEventListener('click', handleNextStation);
        finishTeamBtn.addEventListener('click', handleFinish);
        adminAccessBtn.addEventListener('click', showAdminLogin);
        adminLoginBtn.addEventListener('click', handleAdminLogin);
        backToWelcome.addEventListener('click', backToWelcomeScreen);
        startTimerBtn.addEventListener('click', startGlobalTimer);
        stopTimerBtn.addEventListener('click', stopGlobalTimer);
        resetTimerBtn.addEventListener('click', resetGlobalTimer);
        resetRally.addEventListener('click', resetRallyData);
        logoutAdmin.addEventListener('click', logoutAdminPanel);
        generateLinks.addEventListener('click', generateStationLinks);
        viewResults.addEventListener('click', showResults);
        manageTeams.addEventListener('click', showTeamsManagement);
        saveTeam.addEventListener('click', saveTeamData);
        resetTeamTimes.addEventListener('click', resetTeamTimesData);
        resetTeamAnswers.addEventListener('click', resetTeamAnswersData);
        deleteTeamBtn.addEventListener('click', deleteTeamData);
        refreshTeacher.addEventListener('click', refreshTeacherData);
        backToAdminFromTeacher.addEventListener('click', backToAdminFromTeacherPanel);

        // Medidas de seguridad para prevenir acceso al inspector
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        document.addEventListener('keydown', function(e) {
            // Prevenir F12
            if (e.key === 'F12') {
                e.preventDefault();
            }
            // Prevenir Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) {
                e.preventDefault();
            }
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
            }
        });

        // Obtener estación desde la clave
        function getStationFromKey(key) {
            for (let i = 0; i < stationKeys.length; i++) {
                if (stationKeys[i] === key) {
                    return i + 1;
                }
            }
            return null;
        }

        // Verificar parámetros de URL al cargar la página
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const stationKey = urlParams.get('s');
            const finish = urlParams.get('finish');
            const teacher = urlParams.get('teacher');

            if (stationKey) {
                // Buscar la estación correspondiente a la clave
                const station = getStationFromKey(stationKey);
                if (station) {
                    currentStation = station;
                    showQuestionSelection();
                } else {
                    alert('Estación no válida.');
                }
            } else if (finish) {
                showFinishScreen();
            } else if (teacher) {
                showTeacherPanel();
            }
        });

        // Generar links de estaciones
        function generateStationLinks() {
            const baseUrl = window.location.origin + window.location.pathname;
            linksTableBody.innerHTML = '';
            let allLinks = [];

            for (let i = 1; i <= 10; i++) {
                const key = stationKeys[i-1];
                const link = `${baseUrl}?s=${key}`;
                allLinks.push(link);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i}</td>
                    <td><span class="link-display">${link}</span></td>
                `;
                linksTableBody.appendChild(row);
            }

            linksTable.classList.remove('hidden');
            linksConcatenated.classList.remove('hidden');
            linksString.textContent = allLinks.join(',');
            finishLink.textContent = `${baseUrl}?finish=true`;
            teacherLink.textContent = `${baseUrl}?teacher=true`;
        }

        // Cronómetro global
        function startGlobalTimer() {
            if (timerRunning) return;
            
            // Iniciar el cronómetro visual
            timerStart = Date.now() - timerValue;
            globalTimer = setInterval(updateTimer, 1000);
            timerRunning = true;
            
            // Actualizar tiempo en todos los equipos
            db.collection('teams').get()
                .then(querySnapshot => {
                    const batch = db.batch();
                    querySnapshot.forEach(doc => {
                        const teamRef = db.collection('teams').doc(doc.id);
                        batch.update(teamRef, {
                            startTime: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    return batch.commit();
                })
                .then(() => {
                    console.log('Cronómetro iniciado para todos los equipos');
                })
                .catch(error => {
                    console.error('Error iniciando cronómetro:', error);
                });
        }

        function stopGlobalTimer() {
            if (!timerRunning) return;
            clearInterval(globalTimer);
            timerRunning = false;
        }

        function resetGlobalTimer() {
            stopGlobalTimer();
            timerValue = 0;
            updateTimerDisplay();
        }

        function updateTimer() {
            timerValue = Date.now() - timerStart;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const seconds = Math.floor(timerValue / 1000) % 60;
            const minutes = Math.floor(timerValue / (1000 * 60)) % 60;
            const hours = Math.floor(timerValue / (1000 * 60 * 60));
            document.getElementById('admin-timer').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Vista de finalización
        function showFinishScreen() {
            hideAllScreens();
            finishScreen.classList.remove('hidden');
        }

        function handleFinish() {
            const teamNumber = finishTeamNumber.value;
            const teamKey = finishTeamKey.value;

            if (!teamNumber || !teamKey) {
                showFinishMessage('Por favor ingresa número y clave de equipo', 'error');
                return;
            }

            db.collection('teams').doc(teamNumber).get()
                .then(doc => {
                    if (doc.exists) {
                        const teamData = doc.data();
                        if (teamData.key === teamKey) {
                            // Registrar tiempo de fin
                            return db.collection('teams').doc(teamNumber).update({
                                finishTime: firebase.firestore.FieldValue.serverTimestamp(),
                                completed: true
                            });
                        } else {
                            showFinishMessage('Clave de equipo incorrecta', 'error');
                            throw new Error('Credenciales incorrectas');
                        }
                    } else {
                        showFinishMessage('Número de equipo no encontrado', 'error');
                        throw new Error('Equipo no encontrado');
                    }
                })
                .then(() => {
                    showFinishMessage('Tiempo de finalización registrado correctamente', 'success');
                })
                .catch(error => {
                    if (error.message !== 'Credenciales incorrectas' && error.message !== 'Equipo no encontrado') {
                        console.error('Error registrando tiempo de fin:', error);
                        showFinishMessage('Error al registrar el tiempo de fin', 'error');
                    }
                });
        }

        function showFinishMessage(message, type) {
            finishMessage.textContent = message;
            finishMessage.style.backgroundColor = type === 'error' ? '#ffebee' : '#e8f5e8';
            finishMessage.style.color = type === 'error' ? '#c62828' : '#2e7d32';
            finishMessage.style.border = type === 'error' ? '1px solid #f44336' : '1px solid #4caf50';
            finishMessage.classList.remove('hidden');
        }

        // Gestión de equipos
        function showTeamsManagement() {
            teamsManagement.classList.toggle('hidden');
            if (!teamsManagement.classList.contains('hidden')) {
                loadTeams();
            }
        }

        function loadTeams() {
            db.collection('teams').get()
                .then(snapshot => {
                    const tbody = teamsTable.querySelector('tbody');
                    tbody.innerHTML = '';
                    snapshot.forEach(doc => {
                        const team = doc.data();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${doc.id}</td>
                            <td>${team.key}</td>
                            <td>${team.completed ? 'Sí' : 'No'}</td>
                            <td>
                                <button onclick="editTeam('${doc.id}', '${team.key}', ${team.completed})" class="btn">Editar</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error cargando equipos:', error);
                });
        }

        function editTeam(id, key, completed) {
            teamIdInput.value = id;
            teamKeyInputManagement.value = key;
            teamCompleted.checked = completed;

            // Cargar información adicional del equipo
            db.collection('teams').doc(id).get()
                .then(doc => {
                    const team = doc.data();
                    document.getElementById('team-start-time').textContent = 
                        team.startTime ? team.startTime.toDate().toLocaleString() : 'No establecido';
                    document.getElementById('team-finish-time').textContent = 
                        team.finishTime ? team.finishTime.toDate().toLocaleString() : 'No establecido';
                    const answersCount = team.answers ? Object.keys(team.answers).length : 0;
                    document.getElementById('team-answers-count').textContent = answersCount;
                })
                .catch(error => {
                    console.error('Error cargando detalles del equipo:', error);
                });
        }

        function saveTeamData() {
            const id = teamIdInput.value;
            const key = teamKeyInputManagement.value;
            const completed = teamCompleted.checked;

            if (!id || !key) {
                alert('Por favor ingresa número y clave de equipo');
                return;
            }

            const teamData = {
                key: key,
                completed: completed
                // No sobrescribimos los tiempos y respuestas al guardar
            };

            // Usamos set con merge: true para no sobrescribir campos que no estamos editando
            db.collection('teams').doc(id).set(teamData, { merge: true })
                .then(() => {
                    alert('Equipo guardado correctamente');
                    loadTeams();
                    // No resetear el formulario para permitir más ediciones
                })
                .catch(error => {
                    console.error('Error guardando equipo:', error);
                    alert('Error al guardar el equipo');
                });
        }

        function resetTeamTimesData() {
            const id = teamIdInput.value;
            if (!id) {
                alert('Por favor ingresa un número de equipo');
                return;
            }

            if (!confirm(`¿Estás seguro de que quieres resetear los tiempos del equipo ${id}?`)) {
                return;
            }

            db.collection('teams').doc(id).update({
                startTime: null,
                finishTime: null,
                completed: false
            })
            .then(() => {
                alert('Tiempos reseteados correctamente');
                editTeam(id, teamKeyInputManagement.value, teamCompleted.checked); // Recargar la información
            })
            .catch(error => {
                console.error('Error reseteados tiempos:', error);
                alert('Error al resetear los tiempos');
            });
        }

        function resetTeamAnswersData() {
            const id = teamIdInput.value;
            if (!id) {
                alert('Por favor ingresa un número de equipo');
                return;
            }

            if (!confirm(`¿Estás seguro de que quieres resetear las respuestas del equipo ${id}?`)) {
                return;
            }

            db.collection('teams').doc(id).update({
                answers: {}
            })
            .then(() => {
                alert('Respuestas reseteadas correctamente');
                editTeam(id, teamKeyInputManagement.value, teamCompleted.checked); // Recargar la información
            })
            .catch(error => {
                console.error('Error reseteados respuestas:', error);
                alert('Error al resetear las respuestas');
            });
        }

        function deleteTeamData() {
            const id = teamIdInput.value;
            if (!id) {
                alert('Por favor ingresa un número de equipo');
                return;
            }

            if (!confirm(`¿Estás seguro de que quieres eliminar el equipo ${id}?`)) {
                return;
            }

            db.collection('teams').doc(id).delete()
                .then(() => {
                    alert('Equipo eliminado correctamente');
                    loadTeams();
                    teamIdInput.value = '';
                    teamKeyInputManagement.value = '';
                    teamCompleted.checked = false;
                    document.getElementById('team-start-time').textContent = 'No establecido';
                    document.getElementById('team-finish-time').textContent = 'No establecido';
                    document.getElementById('team-answers-count').textContent = '0';
                })
                .catch(error => {
                    console.error('Error eliminando equipo:', error);
                    alert('Error al eliminar el equipo');
                });
        }

        // Vista de docentes
        function showTeacherPanel() {
            hideAllScreens();
            teacherPanel.classList.remove('hidden');
            refreshTeacherData();
        }

        function refreshTeacherData() {
            db.collection('teams').get()
                .then(snapshot => {
                    const tbody = teacherTable.querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    // Crear un array de promesas para cargar todas las preguntas
                    const promises = [];
                    
                    snapshot.forEach(doc => {
                        const team = doc.data();
                        const teamNumber = doc.id;
                        if (team.answers) {
                            Object.entries(team.answers).forEach(([station, answer]) => {
                                // Cargar la pregunta para obtener el texto
                                const promise = db.collection('questions').doc(answer.questionId).get()
                                    .then(questionDoc => {
                                        const question = questionDoc.data();
                                        const row = document.createElement('tr');
                                        row.innerHTML = `
                                            <td>${station}</td>
                                            <td>${teamNumber}</td>
                                            <td>${question.text}</td>
                                            <td>${question.options[answer.selectedOption]}</td>
                                            <td>${answer.isCorrect ? 'Sí' : 'No'}</td>
                                            <td>${answer.punishment || 'N/A'}</td>
                                        `;
                                        tbody.appendChild(row);
                                    })
                                    .catch(error => {
                                        console.error('Error cargando pregunta:', error);
                                        // Crear una fila con información limitada si no se puede cargar la pregunta
                                        const row = document.createElement('tr');
                                        row.innerHTML = `
                                            <td>${station}</td>
                                            <td>${teamNumber}</td>
                                            <td>Información no disponible</td>
                                            <td>Opción ${answer.selectedOption + 1}</td>
                                            <td>${answer.isCorrect ? 'Sí' : 'No'}</td>
                                            <td>${answer.punishment || 'N/A'}</td>
                                        `;
                                        tbody.appendChild(row);
                                    });
                                promises.push(promise);
                            });
                        }
                    });
                    
                    // Esperar a que todas las promesas se resuelvan
                    return Promise.all(promises);
                })
                .catch(error => {
                    console.error('Error cargando datos de equipos:', error);
                });
        }

        function backToAdminFromTeacherPanel() {
            hideAllScreens();
            adminPanel.classList.remove('hidden');
        }

        // Funciones para el flujo de preguntas con orden aleatorio
        function showQuestionSelection() {
            hideAllScreens();
            questionSelection.classList.remove('hidden');
            stationNumber.textContent = currentStation;
            
            // Generar 3 cartas para la estación actual con orden aleatorio
            cardsContainer.innerHTML = '';
            
            // Crear array con números 1, 2, 3 y mezclarlos aleatoriamente
            const questionSets = [1, 2, 3];
            shuffleArray(questionSets);
            
            for (let i = 0; i < 3; i++) {
                const card = document.createElement('div');
                card.className = 'card-option';
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front">?</div>
                        <div class="card-back">Pregunta ${i + 1}</div>
                    </div>
                `;
                // Asignar el questionSet mezclado a cada carta
                card.addEventListener('click', () => selectQuestion(questionSets[i]));
                cardsContainer.appendChild(card);
            }
        }

        // Función para mezclar array (algoritmo Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function selectQuestion(questionSet) {
            console.log(`🎯 Cargando todas las preguntas para filtrar localmente...`);
            
            // Cargar TODAS las preguntas y filtrar
            db.collection('questions').get()
                .then(querySnapshot => {
                    const todasLasPreguntas = [];
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        todasLasPreguntas.push({ id: doc.id, ...data });
                    });
                    
                    console.log(`📚 Total de preguntas cargadas: ${todasLasPreguntas.length}`);
                    
                    // Filtrar localmente - CORREGIDO PARA MANEJAR AMBOS CAMPOS
                    const preguntasFiltradas = todasLasPreguntas.filter(pregunta => {
                        // Comparar estación (múltiples formatos)
                        const stationMatch = 
                            pregunta.station == currentStation || 
                            pregunta.station === currentStation ||
                            String(pregunta.station) === String(currentStation);
                        
                        // IMPORTANTE: Verificar AMBOS campos - questionSet Y questioned
                        const tieneQuestionSet = pregunta.questionSet !== undefined;
                        const tieneQuestioned = pregunta.questioned !== undefined;
                        
                        let setMatch = false;
                        
                        if (tieneQuestionSet) {
                            setMatch = 
                                pregunta.questionSet == questionSet || 
                                pregunta.questionSet === questionSet ||
                                String(pregunta.questionSet) === String(questionSet);
                        }
                        
                        if (!setMatch && tieneQuestioned) {
                            setMatch = 
                                pregunta.questioned == questionSet || 
                                pregunta.questioned === questionSet ||
                                String(pregunta.questioned) === String(questionSet);
                        }
                        
                        return stationMatch && setMatch;
                    });
                    
                    console.log(`🎯 Preguntas filtradas: ${preguntasFiltradas.length}`);
                    
                    if (preguntasFiltradas.length > 0) {
                        const randomIndex = Math.floor(Math.random() * preguntasFiltradas.length);
                        currentQuestion = preguntasFiltradas[randomIndex];
                        console.log('✅ Pregunta seleccionada:', currentQuestion);
                        showQuestionScreen();
                    } else {
                        console.error('❌ No hay preguntas después del filtrado');
                        alert(`No hay preguntas para la estación ${currentStation}, set ${questionSet}. Contacta al administrador.`);
                    }
                })
                .catch(error => {
                    console.error('Error cargando preguntas:', error);
                    alert('Error de conexión al cargar las preguntas.');
                });
        }

        function showQuestionScreen() {
            hideAllScreens();
            questionScreen.classList.remove('hidden');
            questionStation.textContent = currentStation;
            
            // Validar que currentQuestion existe y tiene los campos necesarios
            if (!currentQuestion || !currentQuestion.text) {
                alert('Error: La pregunta no se cargó correctamente.');
                showQuestionSelection();
                return;
            }
            
            questionText.textContent = currentQuestion.text;
            
            // Mostrar opciones con validación
            optionsContainer.innerHTML = '';
            
            if (currentQuestion.options && Array.isArray(currentQuestion.options) && currentQuestion.options.length >= 4) {
                currentQuestion.options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'option';
                    optionElement.textContent = option || `Opción ${index + 1}`;
                    optionElement.addEventListener('click', () => selectOption(optionElement, index));
                    optionsContainer.appendChild(optionElement);
                });
            } else {
                console.error('Las opciones de la pregunta no están definidas correctamente:', currentQuestion);
                alert('Error: La pregunta no tiene opciones válidas.');
                showQuestionSelection();
                return;
            }
            
            selectedOption = null;
        }

        function selectOption(optionElement, index) {
            // Deseleccionar opción anterior si existe
            const previouslySelected = document.querySelector('.option.selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected');
            }
            
            // Seleccionar nueva opción
            optionElement.classList.add('selected');
            selectedOption = index;
        }

        function handleAnswerSubmission() {
            if (selectedOption === null) {
                alert('Por favor selecciona una opción');
                return;
            }
            
            // Guardar respuesta temporalmente para estudiantes
            teamAnswers = {
                station: currentStation,
                questionId: currentQuestion.id,
                selectedOption: selectedOption,
                isCorrect: selectedOption === currentQuestion.correctAnswer,
                timestamp: new Date(),
                punishment: selectedOption !== currentQuestion.correctAnswer ? currentQuestion.punishment : null
            };
            
            // Mostrar pantalla de registro de equipo
            showTeamRegistration();
        }

        function showTeamRegistration() {
            hideAllScreens();
            teamRegistration.classList.remove('hidden');
            teamNumberInput.value = '';
            teamKeyInput.value = '';
            registrationMessage.classList.add('hidden');
        }

        function handleTeamRegistration() {
            const teamNumber = teamNumberInput.value;
            const teamKey = teamKeyInput.value;
            
            if (!teamNumber || !teamKey) {
                showRegistrationMessage('Por favor ingresa número y clave de equipo', 'error');
                return;
            }
            
            // Verificar credenciales del equipo
            db.collection('teams').doc(teamNumber).get()
                .then(doc => {
                    if (doc.exists) {
                        const teamData = doc.data();
                        // Verificar si la clave coincide
                        if (teamData.key === teamKey) {
                            currentTeam = teamNumber;
                            
                            // Guardar respuesta en Firestore
                            return db.collection('teams').doc(teamNumber).update({
                                [`answers.${currentStation}`]: teamAnswers
                            });
                        } else {
                            showRegistrationMessage('Clave de equipo incorrecta', 'error');
                            throw new Error('Credenciales incorrectas');
                        }
                    } else {
                        showRegistrationMessage('Número de equipo no encontrado', 'error');
                        throw new Error('Equipo no encontrado');
                    }
                })
                .then(() => {
                    showConfirmationScreen();
                })
                .catch(error => {
                    if (error.message !== 'Credenciales incorrectas' && error.message !== 'Equipo no encontrado') {
                        console.error('Error guardando respuesta:', error);
                        showRegistrationMessage('Error al guardar la respuesta', 'error');
                    }
                });
        }

        function showRegistrationMessage(message, type) {
            registrationMessage.textContent = message;
            registrationMessage.style.backgroundColor = type === 'error' ? '#ffebee' : '#e8f5e8';
            registrationMessage.style.color = type === 'error' ? '#c62828' : '#2e7d32';
            registrationMessage.style.border = type === 'error' ? '1px solid #f44336' : '1px solid #4caf50';
            registrationMessage.classList.remove('hidden');
        }

        function showConfirmationScreen() {
            hideAllScreens();
            confirmationScreen.classList.remove('hidden');
        }

        function handleNextStation() {
            // Regresar a la pantalla de bienvenida
            hideAllScreens();
            welcomeScreen.classList.remove('hidden');
        }

        function showAdminLogin() {
            hideAllScreens();
            adminLogin.classList.remove('hidden');
        }

        function handleAdminLogin() {
            const password = adminPasswordInput.value;
            
            if (password === 'Tamarindo09') {
                adminAuthenticated = true;
                showAdminPanel();
            } else {
                adminLoginMessage.textContent = 'Contraseña incorrecta';
                adminLoginMessage.style.backgroundColor = '#ffebee';
                adminLoginMessage.style.color = '#c62828';
                adminLoginMessage.style.border = '1px solid #f44336';
                adminLoginMessage.classList.remove('hidden');
            }
        }

        function backToWelcomeScreen() {
            hideAllScreens();
            welcomeScreen.classList.remove('hidden');
        }

        function showAdminPanel() {
            if (!adminAuthenticated) {
                showAdminLogin();
                return;
            }
            
            hideAllScreens();
            adminPanel.classList.remove('hidden');
            
            // Generar links automáticamente al entrar al panel
            generateStationLinks();
        }

        function logoutAdminPanel() {
            adminAuthenticated = false;
            hideAllScreens();
            welcomeScreen.classList.remove('hidden');
        }

        function resetRallyData() {
            if (confirm('¿Estás seguro de que quieres reiniciar todos los datos del rally? Esta acción no se puede deshacer.')) {
                // Reiniciar todos los equipos
                db.collection('teams').get()
                    .then(querySnapshot => {
                        const batch = db.batch();
                        querySnapshot.forEach(doc => {
                            const teamRef = db.collection('teams').doc(doc.id);
                            batch.update(teamRef, {
                                answers: {},
                                startTime: null,
                                finishTime: null,
                                completed: false
                            });
                        });
                        return batch.commit();
                    })
                    .then(() => {
                        alert('Datos del rally reiniciados');
                    })
                    .catch(error => {
                        console.error('Error reiniciando datos:', error);
                        alert('Error al reiniciar los datos');
                    });
            }
        }

        // Función showResults mejorada
        function showResults() {
            db.collection('teams').get()
                .then(querySnapshot => {
                    const teams = [];
                    querySnapshot.forEach(doc => {
                        teams.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Obtener el tiempo de inicio global si está disponible
                    let globalStartTime = null;
                    if (timerStart) {
                        globalStartTime = new Date(timerStart);
                    }
                    
                    // Calcular puntuación y tiempo para cada equipo
                    const results = teams.map(team => {
                        let score = 0;
                        let time = 'No completado';
                        let stationsCompleted = 0;
                        let actualTime = 'N/A';
                        
                        if (team.answers) {
                            Object.values(team.answers).forEach(answer => {
                                if (answer.isCorrect) score++;
                                stationsCompleted++;
                            });
                        }
                        
                        // CÁLCULO MEJORADO DEL TIEMPO
                        if (team.startTime && team.finishTime) {
                            const start = team.startTime.toDate();
                            const finish = team.finishTime.toDate();
                            const timeDiff = finish - start;
                            
                            // Calcular horas, minutos y segundos
                            const totalSeconds = Math.floor(timeDiff / 1000);
                            const hours = Math.floor(totalSeconds / 3600);
                            const minutes = Math.floor((totalSeconds % 3600) / 60);
                            const seconds = totalSeconds % 60;
                            
                            time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            actualTime = timeDiff; // Guardar para ordenamiento
                            
                        } else if (team.startTime && globalStartTime) {
                            // Si el equipo inició pero no finalizó, calcular tiempo parcial
                            const start = team.startTime.toDate();
                            const currentTime = new Date();
                            const timeDiff = currentTime - start;
                            
                            const totalSeconds = Math.floor(timeDiff / 1000);
                            const hours = Math.floor(totalSeconds / 3600);
                            const minutes = Math.floor((totalSeconds % 3600) / 60);
                            const seconds = totalSeconds % 60;
                            
                            time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} (En curso)`;
                            actualTime = timeDiff;
                        }
                        
                        return {
                            team: team.id,
                            score: score,
                            time: time,
                            actualTime: actualTime, // Para ordenamiento
                            stationsCompleted: stationsCompleted
                        };
                    });
                    
                    // Ordenar por puntuación (descendente) y tiempo (ascendente)
                    results.sort((a, b) => {
                        if (a.score !== b.score) {
                            return b.score - a.score; // Mayor puntuación primero
                        } else {
                            // Si tienen la misma puntuación, ordenar por tiempo
                            // Equipos no completados van al final
                            if (a.actualTime === 'N/A' && b.actualTime === 'N/A') return 0;
                            if (a.actualTime === 'N/A') return 1;
                            if (b.actualTime === 'N/A') return -1;
                            
                            // Menor tiempo primero
                            return a.actualTime - b.actualTime;
                        }
                    });
                    
                    // Mostrar resultados en la tabla
                    const tbody = resultsTable.querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    results.forEach(result => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${result.team}</td>
                            <td>${result.score}</td>
                            <td>${result.time}</td>
                            <td>${result.stationsCompleted}/10</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    resultsTable.classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error cargando resultados:', error);
                    alert('Error al cargar los resultados');
                });
        }

        function hideAllScreens() {
            const screens = [
                welcomeScreen,
                questionSelection,
                questionScreen,
                teamRegistration,
                confirmationScreen,
                finishScreen,
                adminLogin,
                adminPanel,
                teacherPanel
            ];
            
            screens.forEach(screen => {
                screen.classList.add('hidden');
            });
        }

        // Inicializar el cronómetro en el admin
        updateTimerDisplay();
    </script>
</body>
</html>